#!/bin/bash
# opspilot-agent - Launcher for the K8s Troubleshooting Agent (Python)

# Get directory of this script
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Resolve Project Root and Python Script
# Search up the directory tree until we find python/agent_server.py
SEARCH_DIR="$DIR"
PYTHON_SCRIPT=""
count=0

while [[ "$SEARCH_DIR" != "/" && $count -lt 5 ]]; do
    if [ -f "$SEARCH_DIR/python/start_agent.py" ]; then
        PYTHON_SCRIPT="$SEARCH_DIR/python/start_agent.py"
        PROJECT_ROOT="$SEARCH_DIR"
        break
    fi
    SEARCH_DIR="$(dirname "$SEARCH_DIR")"
    ((count++))
done

if [ -z "$PYTHON_SCRIPT" ]; then
    echo "Error: Could not locate python/start_agent.py (searched 5 levels up from $DIR)"
    exit 1
fi

# Active virtual environment if it exists
if [ -d "$PROJECT_ROOT/.venv" ]; then
    source "$PROJECT_ROOT/.venv/bin/activate"
fi

# Install dependencies if needed (rudimentary check)
# In production, this should be handled by the installer
# Use python3 -m pip to ensure compatibility
if ! python3 -m pip freeze | grep -q "fastapi"; then
    echo "Installing Python dependencies..."
    python3 -m pip install fastapi uvicorn httpx langgraph langchain-core pydantic > /dev/null
fi

# Run the server
# We rely on the python script being executable or run via python3
echo "Found agent script at: $PYTHON_SCRIPT"

echo "Starting OpsPilot Agent on port 8765..."
exec python3 "$PYTHON_SCRIPT"
