{
  "id": "rbac-permissions-troubleshooting",
  "title": "RBAC / Forbidden / Unauthorized",
  "category": "troubleshooting",
  "tags": [
    "rbac",
    "permissions",
    "forbidden",
    "unauthorized",
    "serviceaccount",
    "role",
    "clusterrole",
    "rolebinding"
  ],
  "summary": "Diagnose and fix RBAC errors (Forbidden/Unauthorized) for users and service accounts with concrete can-i tests and binding checks.",
  "error_patterns": [
    "forbidden",
    "unauthorized",
    "User .* cannot",
    "system:serviceaccount",
    "RBAC: access denied"
  ],
  "recommended_tools": [
    "RUN_KUBECTL auth can-i <verb> <resource> --as=<user/sa>",
    "RUN_KUBECTL get rolebinding,clusterrolebinding -A",
    "RUN_KUBECTL describe role <role> -n <ns>",
    "RUN_KUBECTL get serviceaccount <sa> -n <ns> -o yaml"
  ],
  "quick_fix": "Use kubectl auth can-i <verb> <resource> --as=system:serviceaccount:<ns>:<sa> to see what’s missing; add/adjust RoleBinding/ClusterRoleBinding accordingly.",
  "symptoms": [
    "Forbidden/Unauthorized on kubectl or pod actions",
    "API calls return 403",
    "Pods failing due to insufficient permissions"
  ],
  "decision_tree": [
    "If SA/user forbidden on a namespace resource → bind a Role in that namespace with required verbs/resources.",
    "If cluster-wide access needed (nodes/namespaces/CRDs) → use ClusterRole + ClusterRoleBinding.",
    "If SA missing entirely → create SA and set spec.serviceAccountName on workloads.",
    "If verbs missing → edit Role/ClusterRole rules to include required verbs (get/list/watch/create/update/patch/delete as needed)."
  ],
  "common_causes": [
    {
      "cause": "Missing binding",
      "description": "Role/ClusterRole not bound to user/SA.",
      "diagnosis": "kubectl get rolebinding,clusterrolebinding -A | grep <sa/user>.",
      "fix": "Create appropriate RoleBinding/ClusterRoleBinding."
    },
    {
      "cause": "Wrong scope",
      "description": "Role (namespaced) used for cluster resources, or vice versa.",
      "diagnosis": "Forbidden on cluster-scoped resources; using Role instead of ClusterRole.",
      "fix": "Use ClusterRole + ClusterRoleBinding for cluster-wide resources."
    },
    {
      "cause": "ServiceAccount not set",
      "description": "Workload uses default SA lacking permissions.",
      "diagnosis": "kubectl get pod -o jsonpath='{.spec.serviceAccountName}'.",
      "fix": "Create SA with proper bindings; set serviceAccountName."
    },
    {
      "cause": "Missing verbs/resources",
      "description": "Role rules lack required verbs.",
      "diagnosis": "kubectl describe role/clusterrole; check rules.",
      "fix": "Add needed verbs/resources/groups; reapply binding."
    }
  ],
  "diagnostic_commands": [
    "kubectl auth can-i <verb> <resource> --as=system:serviceaccount:<ns>:<sa>",
    "kubectl auth can-i --list --as=<user>",
    "kubectl get rolebinding,clusterrolebinding -A | grep <sa/user>",
    "kubectl describe role <role> -n <ns>",
    "kubectl describe clusterrole <cr>"
  ],
  "investigation_flow": [
    "1) Identify actor and failing verb/resource from the error.",
    "2) Test permissions: kubectl auth can-i <verb> <resource> --as=<actor>.",
    "3) If forbidden → check Role/ClusterRole existence and scope.",
    "4) Add/adjust RoleBinding/ClusterRoleBinding to grant required verbs/resources.",
    "5) Verify: rerun auth can-i; retry the operation."
  ]
}
