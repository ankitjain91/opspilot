{
  "id": "pod-security-troubleshooting",
  "title": "Pod Security (PSP/PSS/SCC) Denials",
  "category": "troubleshooting",
  "tags": [
    "pod security",
    "psp",
    "pss",
    "scc",
    "forbidden"
  ],
  "summary": "Resolve pod admission denials from PodSecurity (restricted/baseline) or legacy PSP/SCC.",
  "error_patterns": [
    "violates PodSecurity",
    "forbidden: unable to validate against any pod security policy",
    "SCC",
    "privileged escalation",
    "hostPath not allowed"
  ],
  "recommended_tools": [
    "GET_EVENTS <ns>",
    "RUN_KUBECTL auth can-i create pod --as=<user> -n <ns>",
    "RUN_KUBECTL get psp",
    "RUN_KUBECTL get podsecuritypolicy/podsecurityadmission"
  ],
  "quick_fix": "Align pod spec with the enforced profile (restricted/baseline): drop privileged/hostPath/capabilities; set runAsNonRoot; match allowed seccomp.",
  "symptoms": [
    "Pod creation/update forbidden due to security policy",
    "Events mention PodSecurity restricted/baseline violation",
    "Legacy PSP/SCC errors"
  ],
  "decision_tree": [
    "If PodSecurity restricted/baseline → adjust pod spec to comply (no privileged/hostPath; drop caps; runAsNonRoot).",
    "If PSP/SCC legacy → ensure correct PSP/SCC bound to SA; adjust pod spec to PSP constraints.",
    "If hostPath needed → define allowed paths or use PVC instead; avoid privileged unless required."
  ],
  "common_causes": [
    {
      "cause": "Privileged/host access blocked",
      "description": "Pod requests privileged, hostNetwork, hostPath.",
      "diagnosis": "Events show forbidden for these fields.",
      "fix": "Remove privileged/host*; use PVC; drop capabilities."
    },
    {
      "cause": "runAsNonRoot enforced",
      "description": "Pod runs as root when policy requires non-root.",
      "diagnosis": "Events mention runAsNonRoot violation.",
      "fix": "Set runAsNonRoot: true; runAsUser to non-zero UID."
    },
    {
      "cause": "Missing PSP/SCC binding",
      "description": "ServiceAccount not bound to required PSP/SCC.",
      "diagnosis": "Check RBAC bindings to PSP/SCC.",
      "fix": "Bind SA to appropriate PSP/SCC or migrate to PodSecurity admission."
    }
  ],
  "diagnostic_commands": [
    "kubectl get events -n <ns> --sort-by=.lastTimestamp | tail -n 20",
    "kubectl auth can-i create pod --as=<user> -n <ns>",
    "kubectl get psp",
    "kubectl get scc"
  ],
  "investigation_flow": [
    "1) Check event/error for exact violation (privileged, hostPath, runAsNonRoot, caps).",
    "2) Adjust pod spec to comply: drop privileged/host*, set runAsNonRoot, drop caps, set seccompProfile.",
    "3) For legacy PSP/SCC: ensure SA bound to correct policy; align pod spec to policy constraints.",
    "4) Retry creation; confirm admission passes."
  ]
}
