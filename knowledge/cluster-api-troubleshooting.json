{
  "id": "cluster-api-troubleshooting",
  "title": "Cluster API (CAPI) Troubleshooting",
  "category": "troubleshooting",
  "tags": [
    "capi",
    "cluster-api",
    "provisioning",
    "machines",
    "infrastructure"
  ],
  "summary": "Debug Cluster API provisioning: controller health, Machine/MachineDeployment status, infra errors, and credentials.",
  "error_patterns": [
    "Failed to create",
    "Failed to reconcile",
    "bootstrap failed",
    "infrastructure cluster not ready"
  ],
  "recommended_tools": [
    "GET_CAPI",
    "RUN_KUBECTL get machines -A",
    "RUN_KUBECTL describe machinedeployment <name> -n <ns>",
    "RUN_KUBECTL logs -n capi-system deploy/capi-controller-manager"
  ],
  "quick_fix": "Check CAPI controllers, Machine/MachineDeployment conditions, and infra provider logs; fix credentials/infra errors and retry reconcile.",
  "symptoms": [
    "Machines not provisioning",
    "Clusters not becoming Ready",
    "Errors in bootstrap/infrastructure"
  ],
  "decision_tree": [
    "If controllers down → restart/fix capi-* controllers.",
    "If infra auth/quota errors → fix credentials or quotas in provider.",
    "If bootstrap errors → check cloud-init/bootstrap logs; verify secrets.",
    "If MachineDeployment stuck → inspect conditions; reconcile/rollout as needed."
  ],
  "common_causes": [
    {
      "cause": "Controller health",
      "description": "capi-controller-manager or provider controllers not running.",
      "diagnosis": "kubectl get pods -n capi-system; provider namespaces.",
      "fix": "Restart/fix controller deployments."
    },
    {
      "cause": "Provider auth/quota",
      "description": "Cloud auth/quota issues for infra machines.",
      "diagnosis": "Logs/events show auth/quota errors.",
      "fix": "Update credentials; increase quotas."
    },
    {
      "cause": "Bootstrap failure",
      "description": "Cloud-init/bootstrap script fails.",
      "diagnosis": "Check bootstrap logs on machine; conditions show bootstrap errors.",
      "fix": "Fix bootstrap data; ensure secrets/templates correct."
    }
  ],
  "diagnostic_commands": [
    "kubectl get clusters -A",
    "kubectl get machines -A",
    "kubectl describe machine -n <ns> <name>",
    "kubectl logs -n capi-system deploy/capi-controller-manager | tail -n 100",
    "kubectl logs -n <provider-ns> deploy/*provider* | tail -n 100"
  ],
  "investigation_flow": [
    "1) Check CAPI controllers and provider controllers health.",
    "2) Inspect Machine/MachineDeployment conditions for errors.",
    "3) Review controller logs for auth/quota/bootstrap errors.",
    "4) Fix credentials/quota/bootstrap config; trigger reconcile.",
    "5) Confirm Machines become Ready and Cluster is Ready."
  ]
}
