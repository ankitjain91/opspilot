{
    "id": "cluster-api-troubleshooting",
    "title": "Cluster API (CAPI) Troubleshooting",
    "category": "troubleshooting",
    "tags": [
        "capi",
        "cluster-api",
        "cluster",
        "machine",
        "machinedeployment",
        "kubeadm",
        "infrastructure",
        "bootstrap",
        "controlplane"
    ],
    "summary": "Troubleshooting Cluster API resources for multi-cluster management",
    "resources": {
        "Cluster": "Top-level cluster resource representing a Kubernetes cluster",
        "Machine": "Individual node in a cluster",
        "MachineDeployment": "Manages replicas of Machines (like Deployment for pods)",
        "MachineSet": "Manages a set of Machines (like ReplicaSet)",
        "KubeadmControlPlane": "Control plane nodes managed by kubeadm",
        "KubeadmConfig": "Bootstrap configuration for machines",
        "ClusterClass": "Template for creating clusters"
    },
    "common_causes": [
        {
            "cause": "Cluster stuck in Provisioning",
            "description": "Cluster not reaching Provisioned phase",
            "diagnosis": "kubectl describe cluster <name> -n <namespace>, check InfrastructureReady condition",
            "fix": "Check infrastructure provider (Azure, AWS) for errors, verify credentials"
        },
        {
            "cause": "Machine provisioning failed",
            "description": "VMs not being created or failing to boot",
            "diagnosis": "kubectl get machines -n <namespace>, kubectl describe machine <name>",
            "fix": "Check cloud provider quotas, VM availability, and bootstrap logs"
        },
        {
            "cause": "Control plane not ready",
            "description": "KubeadmControlPlane stuck or failing",
            "diagnosis": "kubectl get kubeadmcontrolplanes -n <namespace>",
            "fix": "Check control plane machine status, etcd health, API server logs"
        },
        {
            "cause": "Bootstrap failure",
            "description": "Machine fails to bootstrap Kubernetes",
            "diagnosis": "kubectl get kubeadmconfigs -n <namespace>, check bootstrap secret",
            "fix": "Verify cloud-init/ignition ran correctly, check machine SSH access"
        },
        {
            "cause": "Infrastructure provider error",
            "description": "Cloud provider failing to create resources",
            "diagnosis": "kubectl get <infra-provider-resource> -n <namespace>",
            "fix": "Check cloud credentials, API limits, region availability"
        }
    ],
    "phases": {
        "Pending": "Cluster waiting to be processed",
        "Provisioning": "Infrastructure being created",
        "Provisioned": "Infrastructure ready, cluster operational",
        "Deleting": "Cluster being deleted",
        "Failed": "Cluster creation failed"
    },
    "diagnostic_commands": [
        "kubectl get clusters.cluster.x-k8s.io -A",
        "kubectl describe cluster <name> -n <namespace>",
        "kubectl get machines -n <namespace>",
        "kubectl get machinedeployments -n <namespace>",
        "kubectl get kubeadmcontrolplanes -n <namespace>",
        "kubectl get kubeadmconfigs -n <namespace>",
        "kubectl logs -n capi-system -l cluster.x-k8s.io/provider=cluster-api"
    ],
    "fix_steps": [
        "1. Check Cluster phase: kubectl get cluster -n <namespace>",
        "2. Check conditions: kubectl describe cluster <name>",
        "3. Verify machines are provisioned: kubectl get machines",
        "4. For control plane: kubectl get kubeadmcontrolplanes",
        "5. Check CAPI operator logs for errors"
    ]
}