{
  "id": "namespace-stuck-terminating",
  "title": "Namespace Stuck Terminating",
  "category": "troubleshooting",
  "tags": [
    "namespace",
    "terminating",
    "finalizer",
    "deletion"
  ],
  "summary": "Clear namespaces stuck in Terminating by finding blocking finalizers/resources and addressing controllers safely.",
  "error_patterns": [
    "Namespace .* is being terminated",
    "finalizer",
    "cannot delete",
    "stuck terminating"
  ],
  "recommended_tools": [
    "GET_NAMESPACE <ns>",
    "LIST_FINALIZERS <ns>",
    "DESCRIBE Namespace <ns>",
    "GET_EVENTS <ns>",
    "RUN_KUBECTL get api-resources --verbs=list"
  ],
  "quick_fix": "Find resources with finalizers (LIST_FINALIZERS <ns>), delete or patch offending resources/finalizers if safe; ensure controllers are running.",
  "symptoms": [
    "kubectl delete ns <ns> hangs",
    "Namespace stuck in Terminating",
    "Resources with finalizers remain"
  ],
  "decision_tree": [
    "If controller exists and healthy → let it clean finalizers; check events/logs.",
    "If controller missing/down → restart/fix controller, then retry deletion.",
    "If external finalizer unreachable → decide whether it’s safe to remove finalizer manually.",
    "If CRDs removed before CR cleanup → recreate CRD temporarily to list/delete remaining CRs."
  ],
  "common_causes": [
    {
      "cause": "Finalizer left on resource",
      "description": "CRDs/objects with finalizers block namespace deletion.",
      "diagnosis": "LIST_FINALIZERS <ns>; kubectl get <kind> -n <ns> -o json | grep finalizers.",
      "fix": "Let controller run; or patch finalizers=[] if safe."
    },
    {
      "cause": "Controller absent",
      "description": "Owning controller removed/crashed.",
      "diagnosis": "Check controller deployment; events show failed cleanup.",
      "fix": "Restore controller; then delete resources cleanly."
    },
    {
      "cause": "External dependency",
      "description": "Cloud resource deletion blocked.",
      "diagnosis": "Events/logs mention cloud API errors.",
      "fix": "Resolve cloud-side issue; retry; as last resort patch finalizer."
    }
  ],
  "diagnostic_commands": [
    "kubectl get namespace <ns> -o yaml",
    "kubectl get all -n <ns>",
    "LIST_FINALIZERS <ns>",
    "kubectl get events -n <ns> --sort-by=.lastTimestamp | tail -n 20"
  ],
  "investigation_flow": [
    "1) Inspect namespace: kubectl get ns <ns> -o yaml (finalizers/status).",
    "2) List blocking resources: LIST_FINALIZERS <ns>; kubectl get all -n <ns>.",
    "3) Ensure controllers running for blocking resources (e.g., CRD controllers).",
    "4) If safe, patch finalizers=[] on stuck resources; otherwise fix controller and let it clean.",
    "5) If CRD removed, recreate CRD temporarily to delete remaining CRs.",
    "6) Retry delete namespace; confirm it disappears."
  ]
}
