{
  "id": "statefulset-troubleshooting",
  "title": "StatefulSet Issues (Pods, PVCs, Ordering)",
  "category": "troubleshooting",
  "tags": [
    "statefulset",
    "pvc",
    "volume",
    "ordering",
    "restart",
    "scale"
  ],
  "summary": "Resolve StatefulSet rollout issues: stuck pods, PVC binding, ordering, and deletion.",
  "error_patterns": [
    "PersistentVolumeClaim .* Pending",
    "volume node affinity conflict",
    "pod has unbound immediate PersistentVolumeClaims",
    "CrashLoopBackOff (stateful pod)"
  ],
  "recommended_tools": [
    "LIST_ALL StatefulSet <ns>",
    "DESCRIBE StatefulSet <ns>/<name>",
    "LIST_ALL Pod <ns>",
    "LIST_ALL PVC <ns>",
    "DESCRIBE Pod <ns>/<pod>",
    "GET_EVENTS <ns>"
  ],
  "quick_fix": "Check PVCs for each ordinal: ensure Bound; fix StorageClass/size/mode. If CrashLoop, treat like normal pod (logs/events).",
  "symptoms": [
    "StatefulSet pods Pending/CrashLoop",
    "PVCs not bound or stuck",
    "Scaling blocked at an ordinal",
    "Deletion stuck due to PVCs/finalizers"
  ],
  "decision_tree": [
    "If PVC Pending → ensure StorageClass exists, PV available, accessModes/size match; check volume node affinity.",
    "If CrashLoop → use crashloop guide; logs/events per pod ordinal.",
    "If stuck at ordinal N → fix pod N first; StatefulSet won’t advance until N is Ready.",
    "If delete stuck → PVCs/finalizers; clean PVCs if data retention not needed."
  ],
  "common_causes": [
    {
      "cause": "PVC not bound",
      "description": "Per-ordinal PVC lacks matching PV/storage.",
      "diagnosis": "kubectl get pvc -n <ns> | grep <setname>-<ordinal>; describe pvc.",
      "fix": "Provide PV/StorageClass; correct size/accessMode; fix node affinity."
    },
    {
      "cause": "CrashLoop in ordinal",
      "description": "Pod crashes, blocking next ordinal.",
      "diagnosis": "Describe pod/logs; same as crashloop guide.",
      "fix": "Fix pod crash; StatefulSet will continue."
    },
    {
      "cause": "Volume node affinity conflict",
      "description": "PV bound to node that cannot schedule pod.",
      "diagnosis": "Describe PVC/PV; check nodeAffinity on PV vs pod/node selectors.",
      "fix": "Adjust selectors or re-provision PV matching target nodes."
    }
  ],
  "diagnostic_commands": [
    "kubectl get statefulset -n <ns> <name> -o wide",
    "kubectl describe statefulset -n <ns> <name>",
    "kubectl get pvc -n <ns> | grep <name>",
    "kubectl describe pvc -n <ns> <pvc>",
    "kubectl describe pod -n <ns> <pod>",
    "kubectl get events -n <ns> --sort-by=.lastTimestamp | tail -n 30"
  ],
  "investigation_flow": [
    "1) List StatefulSet and pods: LIST_ALL StatefulSet/Pod in <ns>.",
    "2) Check which ordinal is blocked (Ready/CrashLoop/Pending).",
    "3) If PVC Pending for that ordinal → fix storage (class/size/mode/node affinity).",
    "4) If CrashLoop → logs/describe per crashloop guide.",
    "5) Verify ordinal becomes Ready; StatefulSet proceeds to next.",
    "6) For delete: ensure PVCs/finalizers removed if safe.",
    "7) Confirm all pods Ready and PVCs Bound."
  ]
}
