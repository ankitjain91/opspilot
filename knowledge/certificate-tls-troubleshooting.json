{
  "id": "certificate-tls-troubleshooting",
  "title": "TLS/Certificate Errors",
  "category": "troubleshooting",
  "tags": [
    "tls",
    "certificate",
    "x509",
    "https",
    "mtls"
  ],
  "summary": "Fix x509/certificate errors for services/webhooks/clients: CA trust, SANs, expiry, and mTLS.",
  "error_patterns": [
    "x509: certificate signed by unknown authority",
    "certificate has expired",
    "certificate is not valid for",
    "remote error: tls",
    "handshake failure"
  ],
  "recommended_tools": [
    "RUN_KUBECTL get secret -A | grep tls",
    "RUN_KUBECTL describe secret -n <ns> <tls-secret>",
    "RUN_KUBECTL get validatingwebhookconfiguration",
    "RUN_KUBECTL logs -n <ns> <pod> | grep -i x509"
  ],
  "quick_fix": "Ensure the client trusts the serving CA (CABundle for webhooks), cert SANs match hostnames, and certs are not expired.",
  "symptoms": [
    "x509 unknown authority",
    "TLS handshake failure",
    "Webhook errors about certificate",
    "Clients cannot connect via HTTPS"
  ],
  "decision_tree": [
    "If unknown authority → add correct CA to trust (CABundle/webhook; client trust store).",
    "If SAN mismatch → regenerate cert with correct DNS/IP SANs.",
    "If expired → renew cert/secret; restart pods using it.",
    "If mTLS → ensure both sides trust each other’s CA and present client certs."
  ],
  "common_causes": [
    {
      "cause": "Wrong or missing CA trust",
      "description": "Client/webhook CABundle lacks correct CA.",
      "diagnosis": "Webhook errors x509 unknown authority; client logs.",
      "fix": "Patch CABundle; add CA to trust; restart using components."
    },
    {
      "cause": "SAN/hostname mismatch",
      "description": "Certificate CN/SANs do not match service DNS.",
      "diagnosis": "Error 'certificate is not valid for <host>'.",
      "fix": "Regenerate cert with correct DNS/IP SANs (service.namespace.svc)."
    },
    {
      "cause": "Expired cert",
      "description": "Serving/client cert expired.",
      "diagnosis": "kubectl describe secret; check NotAfter; logs mention expired.",
      "fix": "Renew/rotate cert; restart pods to pick it up."
    }
  ],
  "diagnostic_commands": [
    "kubectl describe secret -n <ns> <tls-secret>",
    "kubectl get validatingwebhookconfiguration -o yaml | grep -A3 caBundle",
    "kubectl logs -n <ns> <pod> | grep -i x509",
    "kubectl run tls-check --image=ghcr.io/curl/curl --restart=Never -- curl -v https://<svc>.<ns>.svc"
  ],
  "investigation_flow": [
    "1) Capture exact TLS error (unknown authority/SAN/expired).",
    "2) If webhook: verify CABundle matches serving cert CA; patch if needed.",
    "3) If SAN mismatch: regenerate cert with correct DNS/IP SANs for service.",
    "4) If expired: renew cert/secret; restart dependent pods.",
    "5) For mTLS: ensure both client/server trust CAs and present required client certs.",
    "6) Retest connection; ensure no TLS errors."
  ]
}
