{
  "id": "probe-troubleshooting",
  "title": "Liveness/Readiness/Startup Probe Failures",
  "category": "troubleshooting",
  "tags": [
    "probe",
    "liveness",
    "readiness",
    "startupProbe",
    "healthcheck",
    "503"
  ],
  "summary": "Fix probe failures causing restarts or unready pods: timing, paths/ports, sidecars, and slow starts.",
  "error_patterns": [
    "Liveness probe failed",
    "Readiness probe failed",
    "startup probe failed",
    "Probe terminated the container",
    "http probe failed with statuscode 503",
    "context deadline exceeded"
  ],
  "recommended_tools": [
    "DESCRIBE Pod <ns>/<pod>",
    "GET_LOGS <ns>/<pod>",
    "GET_EVENTS <ns>",
    "TOP_PODS",
    "SEARCH_KNOWLEDGE probe failure"
  ],
  "quick_fix": "Increase initialDelaySeconds/failureThreshold, verify probe path/port, and add startupProbe for slow starts.",
  "symptoms": [
    "Pods restart repeatedly without clear app errors",
    "Ready 0/1 due to readiness failures",
    "Liveness kills container before startup completes"
  ],
  "decision_tree": [
    "If app is slow starting → add startupProbe; increase initialDelaySeconds and failureThreshold for liveness/readiness.",
    "If 503/timeout → ensure probe path/port is correct and app listens on that address; allow sidecar/envoy to be ready.",
    "If CPU/memory pegged → check TOP_PODS; resource starvation can break probes.",
    "If sidecars (envoy) present → readiness should wait for sidecar ready; check sidecar readiness endpoints."
  ],
  "common_causes": [
    {
      "cause": "Probe timing too aggressive",
      "description": "Liveness/readiness starts before app is ready.",
      "diagnosis": "Describe pod events show early probe failures; app starts slowly.",
      "fix": "Increase initialDelaySeconds; add startupProbe; increase failureThreshold/periodSeconds."
    },
    {
      "cause": "Wrong path/port/scheme",
      "description": "Probe hits wrong endpoint/port (404/503).",
      "diagnosis": "Probe path differs from app; logs show 404/503.",
      "fix": "Align probe path/port/scheme with app; ensure containerPort matches targetPort."
    },
    {
      "cause": "Sidecar readiness",
      "description": "Envoy/sidecar not ready; app blocked.",
      "diagnosis": "Probes fail until sidecar ready; service mesh present.",
      "fix": "Use appropriate readiness gate or wait for sidecar; check mesh docs."
    },
    {
      "cause": "Resource starvation",
      "description": "CPU/memory pressure delays responses.",
      "diagnosis": "TOP_PODS shows high CPU/mem; timeouts in probe.",
      "fix": "Increase resources; reduce load; optimize app."
    }
  ],
  "diagnostic_commands": [
    "kubectl describe pod -n <ns> <pod> | sed -n '/Events/,$p'",
    "kubectl logs -n <ns> <pod> --previous | head -n 120",
    "kubectl get pod -n <ns> <pod> -o jsonpath='{.spec.containers[*].livenessProbe}'",
    "kubectl top pod -n <ns> <pod>",
    "kubectl get events -n <ns> --sort-by=.lastTimestamp | tail -n 20"
  ],
  "investigation_flow": [
    "1) Describe pod events for probe failures.",
    "2) Check probe config (path/port/scheme/initialDelay/failureThreshold).",
    "3) If slow start → add startupProbe and relax timings.",
    "4) If 404/503 → fix path/port; ensure app listens; consider sidecar readiness.",
    "5) If timeouts + high CPU/mem → increase resources or reduce load.",
    "6) Validate: restart pod; ensure Ready 1/1, restarts stable."
  ]
}
