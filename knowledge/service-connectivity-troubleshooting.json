{
  "id": "service-connectivity-troubleshooting",
  "title": "Service Connectivity, 503/504, No Endpoints",
  "category": "troubleshooting",
  "tags": [
    "service",
    "endpoint",
    "503",
    "504",
    "connection refused",
    "timeout",
    "network",
    "no endpoints"
  ],
  "summary": "Actionable playbook for Service 503/504/connection refused/no endpoints: endpoints, selectors, readiness, ports, and NetworkPolicy.",
  "error_patterns": [
    "503",
    "504",
    "connection refused",
    "no endpoints",
    "endpoint .* not found",
    "service unavailable",
    "connection timed out",
    "connection reset"
  ],
  "recommended_tools": [
    "GET_ENDPOINTS <ns> <service>",
    "DESCRIBE Service <ns> <service>",
    "LIST_ALL Pod <ns>",
    "DESCRIBE Pod <ns> <pod>",
    "GET_EVENTS <ns>",
    "GET_LOGS <ns> <pod> --previous",
    "SEARCH_KNOWLEDGE service 503 endpoint"
  ],
  "quick_fix": "GET_ENDPOINTS <ns> <svc>; if empty, fix Service selector vs pod labels and ensure pods are Ready. If endpoints exist but 503/timeout, check readiness probes and NetworkPolicy.",
  "symptoms": [
    "HTTP 503/504 or connection refused",
    "Service has no endpoints",
    "Pods are Running but not Ready",
    "Traffic works from some pods/namespaces but not others"
  ],
  "decision_tree": [
    "If GET_ENDPOINTS shows 0 ready addresses → check selector vs pod labels; ensure pods are Ready.",
    "If endpoints exist but notReady → fix readiness probe or app health.",
    "If endpoints exist and Ready but 503/timeout → check NetworkPolicy/sidecar/envoy readiness; verify ports/targetPort.",
    "If some clients fail → NetworkPolicy/namespace isolation; verify allowed peers."
  ],
  "common_causes": [
    {
      "cause": "Selector mismatch",
      "description": "Service selector labels do not match pods.",
      "diagnosis": "DESCRIBE Service selector vs pod labels; GET_ENDPOINTS empty.",
      "fix": "Align Service selectors with pod labels or relabel pods."
    },
    {
      "cause": "Pods not Ready",
      "description": "Readiness probe failing or app not healthy.",
      "diagnosis": "Pods show Ready 0/1; describe pod shows readiness probe failures.",
      "fix": "Fix readiness endpoint/port; relax probe timing; ensure app listens."
    },
    {
      "cause": "Port/targetPort mismatch",
      "description": "Service targetPort does not match container port.",
      "diagnosis": "DESCRIBE Service vs containerPorts; endpoints list unexpected port.",
      "fix": "Set targetPort to actual container port."
    },
    {
      "cause": "NetworkPolicy blocking",
      "description": "Policy denies traffic from client to pod.",
      "diagnosis": "Traffic works from some namespaces only; inspect NetworkPolicies in ns.",
      "fix": "Allow ingress from client namespaces/pods to pod ports; test without policy."
    },
    {
      "cause": "No backing pods",
      "description": "Deployment scaled to zero or pods CrashLooping/NotReady.",
      "diagnosis": "LIST_ALL Pod shows 0 or CrashLoopBackOff.",
      "fix": "Scale up deployment; fix pod health."
    }
  ],
  "diagnostic_commands": [
    "kubectl get endpoints -n <ns> <svc> -o wide",
    "kubectl describe svc -n <ns> <svc>",
    "kubectl get pod -n <ns> -l <selector> -o wide",
    "kubectl describe pod -n <ns> <pod> | sed -n '/Readiness/Liveness/,$p'",
    "kubectl get events -n <ns> --sort-by=.lastTimestamp | tail -n 30",
    "kubectl get networkpolicy -n <ns> -o yaml"
  ],
  "investigation_flow": [
    "1) Discover service/pods: LIST_ALL Service/Pod in <ns>; get <svc> and backing pods.",
    "2) Endpoints: GET_ENDPOINTS <ns> <svc>. If none, fix selector or scale pods.",
    "3) Selectors: DESCRIBE Service <svc>; compare selector to pod labels (LIST_ALL Pod).",
    "4) Readiness: DESCRIBE Pod <pod> for readiness probe failures; fix path/port/timing; ensure app listens.",
    "5) Ports: Verify Service port/targetPort matches containerPorts.",
    "6) NetworkPolicy: If endpoints ready but 503/timeout, check policies; allow traffic from clients.",
    "7) Confirm: retest traffic; endpoints should be Ready; 503/timeout resolved."
  ]
}
