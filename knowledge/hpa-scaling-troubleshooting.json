{
  "id": "hpa-scaling-troubleshooting",
  "title": "HPA Scaling Issues",
  "category": "troubleshooting",
  "tags": [
    "hpa",
    "autoscaling",
    "cpu",
    "memory",
    "metrics",
    "scaling"
  ],
  "summary": "Fix HPAs that won't scale up/down: verify metrics availability, targets, min/max, and pod readiness.",
  "error_patterns": [
    "failed to get cpu utilization",
    "metrics not available",
    "unable to compute replicas",
    "did not receive metrics"
  ],
  "recommended_tools": [
    "RUN_KUBECTL get hpa -A",
    "RUN_KUBECTL describe hpa <name> -n <ns>",
    "RUN_KUBECTL get --raw \"/apis/metrics.k8s.io/v1beta1\"",
    "TOP_PODS",
    "GET_EVENTS <ns>"
  ],
  "quick_fix": "Describe the HPA to see current metrics/targets; ensure metrics-server is running; adjust target thresholds and min/max replicas.",
  "symptoms": [
    "HPA not scaling up/down despite load",
    "Events show missing metrics",
    "Replicas stuck at min or max"
  ],
  "decision_tree": [
    "If metrics unavailable → ensure metrics-server is running/authorized; check api/metrics endpoint.",
    "If target too high/low → adjust cpu/memory/utilization targets.",
    "If pods not Ready → HPA may not scale; fix pod readiness/resource limits.",
    "If at maxReplicas but still high load → increase max or optimize workload."
  ],
  "common_causes": [
    {
      "cause": "Metrics server not working",
      "description": "No resource metrics available for HPA.",
      "diagnosis": "Describe HPA shows missing metrics; metrics.k8s.io unavailable.",
      "fix": "Install/fix metrics-server; ensure RBAC/certs correct."
    },
    {
      "cause": "Targets misconfigured",
      "description": "CPU/memory targets unreachable or too lax.",
      "diagnosis": "Describe HPA shows current vs target utilization.",
      "fix": "Set realistic target utilization; adjust min/max replicas."
    },
    {
      "cause": "Pods not Ready or throttled",
      "description": "Unready pods excluded from metrics; throttling affects metrics.",
      "diagnosis": "Check pod readiness; TOP_PODS for CPU/mem throttling.",
      "fix": "Fix readiness; adjust limits/requests."
    }
  ],
  "diagnostic_commands": [
    "kubectl get hpa -n <ns>",
    "kubectl describe hpa -n <ns> <name>",
    "kubectl get --raw \"/apis/metrics.k8s.io/v1beta1\" | head",
    "kubectl top pods -n <ns>",
    "kubectl get events -n <ns> --sort-by=.lastTimestamp | tail -n 30"
  ],
  "investigation_flow": [
    "1) Describe HPA to see current/target metrics and events.",
    "2) Verify metrics-server/API: kubectl get --raw /apis/metrics.k8s.io/v1beta1.",
    "3) Check pod readiness and resource usage (kubectl top pods).",
    "4) Adjust target utilization and min/max replicas if needed.",
    "5) If at max and still high load, increase max or optimize workload.",
    "6) Confirm scaling by applying load test; watch HPA status."
  ]
}
