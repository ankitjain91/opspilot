{
  "id": "kb-205",
  "title": "Service Mesh Troubleshooting (Istio/Linkerd)",
  "category": "troubleshooting",
  "tags": ["istio", "linkerd", "service-mesh", "sidecar", "envoy", "mtls", "traffic"],
  "summary": "Guide for debugging service mesh issues including sidecar injection, mTLS, and traffic policies",

  "service_mesh_basics": {
    "description": "Common service mesh concepts",
    "concepts": {
      "sidecar_proxy": {
        "description": "Envoy/linkerd-proxy container injected into pods",
        "purpose": "Handles all network traffic for the pod"
      },
      "mtls": {
        "description": "Mutual TLS between services",
        "modes": ["STRICT (only mTLS)", "PERMISSIVE (mTLS or plaintext)", "DISABLE"]
      },
      "control_plane": {
        "istio": ["istiod"],
        "linkerd": ["linkerd-controller", "linkerd-identity", "linkerd-destination"]
      }
    },
    "commands": {
      "istio": [
        {
          "command": "istioctl proxy-status",
          "description": "Check if proxies are in sync with control plane"
        },
        {
          "command": "istioctl analyze -n <namespace>",
          "description": "Analyze configuration for issues"
        },
        {
          "command": "istioctl proxy-config listeners <pod> -n <ns>",
          "description": "View Envoy listener configuration"
        }
      ],
      "linkerd": [
        {
          "command": "linkerd check",
          "description": "Comprehensive health check"
        },
        {
          "command": "linkerd viz stat deploy -n <ns>",
          "description": "View traffic stats for deployments"
        }
      ]
    }
  },

  "common_errors": [
    {
      "name": "Sidecar not injected",
      "error_patterns": [
        "Pod has no sidecar container",
        "Only one container in pod"
      ],
      "symptoms": [
        "Pod not part of mesh",
        "No traffic metrics for pod",
        "mTLS failures to this pod"
      ],
      "likely_causes": [
        "Namespace not labeled for injection",
        "Pod has injection disabled annotation",
        "Webhook not running or misconfigured"
      ],
      "diagnostic_commands": [
        "kubectl get ns <namespace> --show-labels",
        "kubectl get pod <pod> -n <ns> -o yaml | grep -i sidecar",
        "kubectl get mutatingwebhookconfigurations | grep istio",
        "kubectl logs -n istio-system deploy/istiod | grep injection"
      ],
      "fix_steps": [
        "Label namespace: kubectl label namespace <ns> istio-injection=enabled",
        "Remove sidecar.istio.io/inject: 'false' annotation if present",
        "Restart pod to trigger injection: kubectl rollout restart deploy <name>",
        "Check webhook is running: kubectl get pods -n istio-system"
      ]
    },
    {
      "name": "503 Service Unavailable from mesh",
      "error_patterns": [
        "upstream connect error",
        "no healthy upstream",
        "UH flag in access logs"
      ],
      "symptoms": [
        "Service-to-service calls failing with 503",
        "Intermittent failures between meshed services"
      ],
      "likely_causes": [
        "Destination pod not ready",
        "mTLS mode mismatch",
        "DestinationRule missing",
        "Endpoint not discovered"
      ],
      "diagnostic_commands": [
        "kubectl get endpoints <service> -n <ns>",
        "istioctl proxy-config endpoints <source-pod> -n <ns> | grep <dest-service>",
        "kubectl logs <pod> -c istio-proxy -n <ns> | tail -50",
        "istioctl analyze -n <ns>"
      ],
      "fix_steps": [
        "Verify destination pods are Ready",
        "Check mTLS: kubectl get peerauthentication,destinationrule -n <ns>",
        "Ensure service ports match pod ports",
        "Check if VirtualService is routing to correct host"
      ]
    },
    {
      "name": "mTLS handshake failures",
      "error_patterns": [
        "TLS error",
        "connection reset",
        "upstream connect error or disconnect/reset before headers"
      ],
      "symptoms": [
        "Connections failing between services",
        "Only some services affected"
      ],
      "likely_causes": [
        "mTLS mode mismatch (one side strict, other permissive)",
        "Non-mesh service calling mesh service in strict mode",
        "Certificate issues"
      ],
      "diagnostic_commands": [
        "istioctl authn tls-check <pod> -n <ns>",
        "kubectl get peerauthentication -A",
        "kubectl get destinationrule -A | grep mtls",
        "istioctl proxy-config secret <pod> -n <ns>"
      ],
      "fix_steps": [
        "For non-mesh clients: Set PeerAuthentication to PERMISSIVE",
        "Ensure DestinationRule tls mode matches PeerAuthentication",
        "Check service is using correct port naming (http-*, grpc-*)",
        "Verify certificates are valid: istioctl proxy-config secret <pod>"
      ],
      "example_fix": {
        "description": "Allow both mTLS and plaintext",
        "yaml": "apiVersion: security.istio.io/v1beta1\nkind: PeerAuthentication\nmetadata:\n  name: default\nspec:\n  mtls:\n    mode: PERMISSIVE"
      }
    },
    {
      "name": "Traffic not following VirtualService rules",
      "error_patterns": [
        "Traffic going to wrong version",
        "Routing rules not applied"
      ],
      "symptoms": [
        "Canary deployment getting all traffic",
        "Header-based routing not working"
      ],
      "likely_causes": [
        "VirtualService host doesn't match request",
        "Missing DestinationRule subsets",
        "Conflicting VirtualServices"
      ],
      "diagnostic_commands": [
        "kubectl get virtualservice,destinationrule -n <ns>",
        "istioctl analyze -n <ns>",
        "istioctl proxy-config routes <pod> -n <ns> --name <port>",
        "kubectl logs <pod> -c istio-proxy | grep route"
      ],
      "fix_steps": [
        "Ensure VirtualService hosts includes the service being called",
        "Check DestinationRule has matching subsets",
        "Verify no conflicting VirtualServices for same host",
        "Check gateway is configured if external traffic"
      ]
    },
    {
      "name": "High latency through mesh",
      "error_patterns": [
        "Slow response times",
        "Timeout errors"
      ],
      "symptoms": [
        "Services slower after mesh enabled",
        "P99 latency significantly higher"
      ],
      "likely_causes": [
        "Sidecar resource limits too low",
        "Too many retries configured",
        "Circuit breaker tripping",
        "Control plane overloaded"
      ],
      "diagnostic_commands": [
        "kubectl top pods -n <ns>",
        "istioctl proxy-config cluster <pod> | grep circuit",
        "kubectl logs -c istio-proxy <pod> | grep timeout",
        "linkerd viz stat deploy -n <ns>"
      ],
      "fix_steps": [
        "Increase sidecar resources if CPU-throttled",
        "Tune retry and timeout settings",
        "Adjust circuit breaker thresholds",
        "Check control plane resource usage"
      ]
    }
  ],

  "istio_debugging_workflow": {
    "description": "Step-by-step Istio debugging",
    "steps": [
      {
        "step": 1,
        "check": "Control plane healthy",
        "command": "kubectl get pods -n istio-system"
      },
      {
        "step": 2,
        "check": "Proxy sync status",
        "command": "istioctl proxy-status"
      },
      {
        "step": 3,
        "check": "Configuration analysis",
        "command": "istioctl analyze -n <namespace>"
      },
      {
        "step": 4,
        "check": "Proxy logs for errors",
        "command": "kubectl logs <pod> -c istio-proxy -n <ns> --tail=100"
      },
      {
        "step": 5,
        "check": "Envoy config for specific route",
        "command": "istioctl proxy-config routes <pod> -n <ns>"
      }
    ]
  },

  "linkerd_debugging_workflow": {
    "description": "Step-by-step Linkerd debugging",
    "steps": [
      {
        "step": 1,
        "check": "Overall health",
        "command": "linkerd check"
      },
      {
        "step": 2,
        "check": "Data plane status",
        "command": "linkerd check --proxy"
      },
      {
        "step": 3,
        "check": "Traffic stats",
        "command": "linkerd viz stat deploy -n <namespace>"
      },
      {
        "step": 4,
        "check": "Live traffic",
        "command": "linkerd viz tap deploy/<name> -n <namespace>"
      }
    ]
  },

  "best_practices": {
    "operations": [
      "Use istioctl analyze before applying changes",
      "Test configuration in staging first",
      "Monitor control plane resource usage",
      "Set appropriate resource limits for sidecars"
    ],
    "troubleshooting": [
      "Check proxy-status first for sync issues",
      "Use access logs for debugging traffic flow",
      "Compare working vs non-working pod configs",
      "Verify port naming conventions (http-*, grpc-*)"
    ]
  }
}
