{
    "id": "istio-gateway-troubleshooting",
    "title": "Istio Gateway and VirtualService Troubleshooting",
    "category": "troubleshooting",
    "tags": [
        "istio",
        "gateway",
        "virtualservice",
        "envoy",
        "proxy",
        "503",
        "404",
        "routing",
        "mesh",
        "ingress"
    ],
    "summary": "Troubleshooting Istio service mesh, gateways, and traffic routing issues",
    "error_patterns": [
        "503 Service Unavailable",
        "404 Not Found",
        "upstream connect error",
        "no healthy upstream",
        "connection refused",
        "gateway.*not found"
    ],
    "recommended_tools": [
        "GET_ISTIO",
        "DESCRIBE",
        "GET_EVENTS",
        "GET_ENDPOINTS",
        "RUN_KUBECTL"
    ],
    "quick_fix": "kubectl get gateways,virtualservices -A && kubectl get pods -n istio-system",
    "key_concepts": {
        "Gateway": "Entry point for external traffic (like Ingress)",
        "VirtualService": "Traffic routing rules",
        "DestinationRule": "Load balancing and connection pool settings",
        "Sidecar": "Envoy proxy injected into pods"
    },
    "symptoms": [
        "503 errors from gateway",
        "404 errors for routes that should exist",
        "Connection refused",
        "Requests timing out",
        "Traffic not reaching pods"
    ],
    "common_causes": [
        {
            "cause": "503 - No healthy upstream",
            "description": "Gateway can't reach backend pods",
            "diagnosis": "Check endpoints exist and pods are ready",
            "fix": "Verify service selector matches pod labels, check pod health"
        },
        {
            "cause": "404 - Route not matched",
            "description": "VirtualService route doesn't match request",
            "diagnosis": "Check VirtualService hosts and match rules",
            "fix": "Align VirtualService with actual request path/host"
        },
        {
            "cause": "Gateway not selecting VirtualService",
            "description": "VirtualService.gateways doesn't include the Gateway",
            "diagnosis": "Compare Gateway.metadata.name with VirtualService.gateways",
            "fix": "Add gateway name to VirtualService.spec.gateways"
        },
        {
            "cause": "mTLS mismatch",
            "description": "Client not using TLS when service requires it",
            "diagnosis": "Check PeerAuthentication and DestinationRule TLS mode",
            "fix": "Align TLS settings between client and server"
        },
        {
            "cause": "Sidecar not injected",
            "description": "Pod missing Istio proxy",
            "diagnosis": "Check pod has istio-proxy container",
            "fix": "Label namespace with istio-injection=enabled, restart pods"
        }
    ],
    "diagnostic_commands": [
        "kubectl get gateways -A",
        "kubectl get virtualservices -A",
        "kubectl get destinationrules -A",
        "kubectl get pods -n istio-system",
        "kubectl describe gateway <name> -n <ns>",
        "kubectl describe virtualservice <name> -n <ns>",
        "istioctl analyze",
        "istioctl proxy-status"
    ],
    "investigation_flow": [
        "1. GET_ISTIO to see gateways and virtual services",
        "2. Check istio-system pods are healthy",
        "3. Describe gateway and virtualservice",
        "4. Verify VirtualService.gateways includes your gateway",
        "5. Check service endpoints exist",
        "6. Verify sidecar injection"
    ]
}