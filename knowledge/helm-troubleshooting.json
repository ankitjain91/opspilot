{
  "id": "helm-troubleshooting",
  "title": "Helm Install/Upgrade Failures",
  "category": "troubleshooting",
  "tags": [
    "helm",
    "install",
    "upgrade",
    "rollback",
    "crd"
  ],
  "summary": "Resolve Helm install/upgrade issues: failed hooks, CRD ordering, timeouts, and rollbacks.",
  "error_patterns": [
    "failed post-install",
    "failed pre-upgrade",
    "timed out waiting for",
    "cannot patch .*",
    "CRD .* already exists",
    "UPGRADE FAILED"
  ],
  "recommended_tools": [
    "RUN_KUBECTL get events -A | tail -n 50",
    "RUN_KUBECTL get pods -A | grep <release>",
    "RUN_KUBECTL get crd | grep <crd>",
    "RUN_KUBECTL get helmreleases -A (if flux/argo)"
  ],
  "quick_fix": "If hooks timed out, inspect hook jobs/pods; delete failed hooks and rerun. For CRD conflicts, install/upgrade CRDs separately with --skip-crds or --include-crds as appropriate.",
  "symptoms": [
    "helm install/upgrade fails or times out",
    "Release stuck in pending/failed state",
    "CRD already exists errors"
  ],
  "decision_tree": [
    "If timeout → identify resources stuck (pods/Jobs/hooks); fix underlying pod issues (logs/events).",
    "If CRD already exists → install CRDs separately (apply) or use --skip-crds on upgrade.",
    "If hook failed → inspect hook pod logs/events; delete failed hook resources; rerun.",
    "If immutable field errors → delete/replace resource or adjust values to avoid immutable change."
  ],
  "common_causes": [
    {
      "cause": "Hook job/pod failed",
      "description": "Helm hook pod fails and blocks release.",
      "diagnosis": "kubectl get pods -A | grep hook; logs/events for hook pods.",
      "fix": "Fix hook failure; delete failed hook pod/job; rerun helm."
    },
    {
      "cause": "CRD conflict",
      "description": "CRD already exists or version mismatch.",
      "diagnosis": "helm error mentions CRD exists; kubectl get crd <name>.",
      "fix": "Manage CRDs separately; use --skip-crds or apply CRDs first."
    },
    {
      "cause": "Resource immutable fields",
      "description": "Upgrade tries to change immutable fields.",
      "diagnosis": "Helm output mentions immutable; check resource diff.",
      "fix": "Delete/recreate resource or adjust values to avoid immutable change."
    }
  ],
  "diagnostic_commands": [
    "helm list -A",
    "helm status <release> -n <ns>",
    "kubectl get pods -A | grep <release>",
    "kubectl logs -n <ns> <hook-pod> --previous",
    "kubectl get events -A --sort-by=.lastTimestamp | tail -n 50"
  ],
  "investigation_flow": [
    "1) helm status <release> -n <ns>; note failing hooks/resources.",
    "2) Inspect hook pods/jobs: kubectl get pods -A | grep <release>; logs/events for failures.",
    "3) If CRD conflict: install/upgrade CRDs separately; rerun with --skip-crds.",
    "4) If timeout: find stuck pods/resources; fix CrashLoop/Readiness/NP issues; rerun helm.",
    "5) If immutable errors: delete/recreate offending resource or adjust values.",
    "6) Confirm release deployed; helm status shows deployed/success."
  ]
}
